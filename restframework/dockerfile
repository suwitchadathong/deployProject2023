# เลือกใช้ Python 3.10 จาก Alpine Linux เป็นฐาน
FROM python:3.10-alpine

# ตั้งค่า environment variable เพื่อไม่ให้ Python มีการ buffer output
ENV PYTHONUNBUFFERED 1

# อัปเดตและติดตั้ง dependencies ที่จำเป็นสำหรับการทำงานของโปรแกรม
RUN apk update && apk add python3-dev gcc libc-dev

# ติดตั้ง dependencies ที่จำเป็นสำหรับการใช้งาน opencv-python
RUN apk add --no-cache cmake make gcc g++

# กำหนดไดเรกทอรีทำงานเป็น /code
WORKDIR /code

# คัดลอกไฟล์ requirements.txt ไปยังโฟลเดอร์ /code
COPY ./requirements.txt /code/requirements.txt

# ติดตั้ง dependencies จากไฟล์ requirements.txt โดยใช้ pip
RUN pip install --no-cache-dir --upgrade pip && pip install -r /code/requirements.txt

# คัดลอกโค้ดจากโฟลเดอร์ปัจจุบันไปยังโฟลเดอร์ /code
COPY . .

# กำหนด port ที่เปิดให้ Docker container
EXPOSE 8000

# ทำการ migrate database และเริ่มการทำงานของ celery worker และ beat
RUN python ./manage.py makemigrations && python ./manage.py migrate && celery -A mysite worker --loglevel=info && celery -A mysite beat --loglevel=info

# คำสั่งที่ใช้เมื่อ Docker container ถูกเริ่มต้น
CMD ["python", "./manage.py", "runserver", "0.0.0.0:8000"]